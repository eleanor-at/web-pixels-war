<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Pixel Wars</title>
    <style>
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .map {
            display: grid;
            grid-template-columns: repeat(3, 10px);
            grid-template-rows: repeat(3, 10px);
        }
        .pixel {
            width: 10px;
            height: 10px;
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <input type="text" name="adresse" id="adresse" value="https://pixels-war.oie-lab.net">
            <input type="text" name="carte" id="carte" value="TEST">
        </div>

        <div class="map" id="map">
            <!-- Pixels seront générés dynamiquement -->
        </div>

        <div class="footer">
            <input type="color" name="couleur" id="couleur" value="#FF0000">
        </div>
    </div>

    <script>
        const adresse = document.querySelector("#adresse").value;
        const carte = document.querySelector("#carte").value;
        const couleur = document.querySelector("#couleur").value;
        const mapElement = document.querySelector("#map");

        async function preinit() {
            const res = await fetch(`${adresse}/api/v1/${carte}/preinit`, { credentials: "include" });
            const { key } = await res.json();
            console.log("Preinit key:", key);
            init(key);
        }

        async function init(key) {
    const res = await fetch(`${adresse}/api/v1/${carte}/init?key=${key}`, { credentials: "include" });
    const { id, nx, ny, timeout, data } = await res.json();
    
    let contenu = "";
    for (let col = 0; col < nx; col++) {
        for (let li = 0; li < ny; li++) {
            const [r, g, b] = data[li][col];
            contenu += `<div class="pixel" id="l${li}_c${col}" style="background-color: rgb(${r}, ${g}, ${b})"></div>`;
        }
    }

    mapElement.innerHTML = contenu;
    mapElement.style.gridTemplateColumns = `repeat(${nx}, 10px)`;
    mapElement.style.gridTemplateRows = `repeat(${ny}, 10px)`;

    
    const pixels = document.querySelectorAll(".pixel");
    pixels.forEach(pixel => {
        pixel.addEventListener("click", async (e) => {
            const [li, col] = e.target.id.match(/\d+/g).map(Number);
            const colorHex = document.querySelector("#couleur").value;
            const r = parseInt(colorHex.substring(1, 3), 16);
            const g = parseInt(colorHex.substring(3, 5), 16);
            const b = parseInt(colorHex.substring(5, 7), 16);

            const url = `${adresse}/api/v1/${carte}/set/${id}/${col}/${li}/${r}/${g}/${b}`;
            console.log("Set URL:", url);

            try {
                await fetch(url, { method: "POST", credentials: "include" });
            } 
        });
    });

    setInterval(() => deltas(id), 1000);
}

        async function deltas(id) {
            const res = await fetch(`${adresse}/api/v1/${carte}/deltas?id=${id}`, { credentials: "include" });
            const { deltas } = await res.json();

            for (const [x, y, r, g, b] of deltas) {
                const pixel = document.querySelector(`#l${y}_c${x}`);
                if (pixel) {
                    pixel.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                }
            }
        }

        preinit();
    </script>
</body>
</html>
